#pragma once

#include <string>

#ifndef VER_STR
#define VER_STR "v0.0.0.0"
#endif

//from PicoLove api.lua

const char * fake08BiosP8 = R"#(
pico-8 cartridge // http://www.pico-8.com
version 35
__lua__
--all themes

--start customizable per platform
cartpath = "sdmc:/p8carts/"
selectbtn = "a"
pausebtn = "start"
versionstr = ")#" VER_STR  R"#("
exitbtn = "l + r"
sizebtn = "select to cycle screen sizes"
--end customizable per platform

darkenpal = {0,0,1,1,5,5,13,5,5,13,13,13,1,13,13}
darkenpal[0] = 0
-->8
--classic

function classic_init()

	carts={}
	numcarts = 0
	
	usestring = true
	
	if __getsetting then
			pal(1, __getsetting('p8_bgcolor'))
			pal(7, __getsetting('p8_textcolor'))
	else
		carts = {'cart1.p8','cart2.p8.png','thirdcart.p8'}
		numcarts = 3
		usestring = false
	end
	
	
	cidx=0
	carttoload = ""
	t=0
	linebuffer=""
	
	bgcolor=1
	runcmd=false

	if __listcarts then
		carts = __listcarts()
		numcarts = #carts
	end

	if __getbioserror then
		linebuffer = __getbioserror()
	end
end

function classic_update()
	t+=1
	if btnp(1) then
		cidx = min((cidx + 1), numcarts)
	end
	if btnp(0) then
		cidx = max((cidx - 1), 1)
	end
	
	if btnp(2) then
		cidx = max((cidx - 10), 1)
	end
	if btnp(3) then
		cidx = min((cidx + 10), numcarts)
	end

	if btnp(4) then
		linebuffer = ""
	end
	if btnp(5) then
		linebuffer = ""
		runcmd = true
	end
	
	if cidx > 0 and cidx <= numcarts then
		carttoload = carts[cidx]
		local lastslashidx = nil
		if usestring then
			lastslashidx = string.find(carttoload, "/[^/]*$")
		end
		local dispstr = carttoload
		if lastslashidx ~= nil and lastslashidx > 0 then
			dispstr = sub(dispstr, lastslashidx + 1)
		end
		linebuffer = "load " .. dispstr
	else
		carttoload = ""
	end
	
	if runcmd then
		--make call to global
		--load cart here
		
		if load and carttoload then
			load(carttoload)
		end
	end
		
end

function classic_draw()
	cls()
	rectfill(0,0,128,128,bgcolor)
	spr(128, 1, 5, 6, 1)
	color(7)
	cursor(0, 6*3)
	print("welcome to fake-08")
	print("a homebrew pico-8 emulator")
	print("currently in alpha (" .. versionstr .. ")")
	print("")
	print("place p8 carts in " .. cartpath)
	if numcarts < 1 then
		print("--no carts found--")
	else
		print("⬅️➡️ to navigate carts 1 by 1")
		print("⬆️⬇️ to navigate carts 10 by 10")
		print("🅾️ (" .. selectbtn .. ") to load selected cart")
		print(pausebtn .. " to close current cart")
	end
	print(sizebtn)
	print(exitbtn .. " to exit")
	print("")
	-- 18 pixels from cursor() call, then 
	-- 24 more from 4 print calls
	linenum=84


	rectfill(0, linenum, 128, linenum+5, bgcolor)
	color(7)
	print("> "..linebuffer, 0, linenum)
	if t%30<15 then
		rectfill((#linebuffer+2)*4, linenum, (#linebuffer+2)*4+3, linenum+4, 8)
	end
end

-->8
--fancy

function fancy_init()
	carts={}
	numcarts = 0
	
	usestring = true
	
	showerror = false
	bioserror = ''
	errortable = {'error! press ❎ to close.'}
	if __getbioserror then
		bioserror = __getbioserror()
	end
	
	if bioserror != '' then
		showerror = true
		while true do
			if #bioserror >= 26 then
				add(errortable,sub(bioserror,1,26))
				bioserror = sub(bioserror,27,-1)
			else
				add(errortable,bioserror)
				break
			end
		end
	end
	
	if __getsetting then
			bgcolor = __getsetting('p8_bgcolor')
			textcolor = __getsetting('p8_textcolor')
	else
		bgcolor=1
		textcolor = 7
	end
	
	
	cidx=0
	carttoload = ""
	t=0
	linebuffer=""
	
	
	runcmd=false
	
	cpos = 0
	dcpos = 0
	loadedimages = {}

	if __listcarts then
		cartnames = __listcarts()
		numcarts = #cartnames
	else
		cartnames = {'cart1.p8','cart2.p8.png','thirdcart.p8','cart4.p8','5cart.p8','c6.p8','theseventhcart.p8.png'}
		--cartnames = {}
		numcarts = #cartnames
		usestring = false
	end
	
	for i,v in ipairs(cartnames) do
		local newcart = {}
		newcart.name = v
		newcart.id = i - 1
		newcart.sprite = newcart.id%4
		

		add(carts,newcart)
	end
	updatecarts()


end

function updatecarts()
	for i,v in ipairs(carts) do
		if v.id >= cpos -1 and v.id <= cpos+1 then
			v.visible = true
			
			if loadedimages[v.sprite] ~= v.name then
				loadedimages[v.sprite] = v.name
				if __loadlabel then
					__loadlabel(v.name,true,v.sprite*16)
				end
			end
		
		else
			v.visible = false
		end
		if v.id == cpos then
			carttoload = v.name
		end
	end
end

function fancy_update()
	if showerror then
		if btnp(❎) then
			showerror = false
		end
	else
		if btnp(➡️) then
			cpos = (cpos + 1)%numcarts
			updatecarts()
		end
		if btnp(⬅️) then
			cpos = (cpos - 1)%numcarts
			updatecarts()
		end
		dcpos = (cpos*0.5 + dcpos*1.5) / 2
		
		if btnp(❎) then
			if load and carttoload then
				load(carttoload)
			end
		end
	end
	
end

function drawcart(v)
	local cartx = (v.id-dcpos+1)*44+4
	local carty = 60
	
	carty+= sin((v.id-dcpos+1)/4)*10
	--base
	rectfill(cartx - 4,
	carty-6,
	cartx+35,
	carty+42,
	5)
	line(cartx-4,carty+43,cartx+34,carty+43,5)
	line(cartx-4,carty+44,cartx+33,carty+44,5)
	
	--border
	line(cartx-4,carty-7,cartx+35,carty-7,0)
	line(cartx-5,carty-6,cartx-5,carty+44,0)
	line(cartx+36,carty-6,cartx+36,carty+42,0)
	line(cartx+34,carty+44,cartx+36,carty+42,0)
	line(cartx-4,carty+45,cartx+33,carty+45,0)
	
	--label
	rect(cartx-1,carty-1,cartx+32,carty+32,0)
	spr(v.sprite*4,
		cartx,
		carty,
	4,4)
	
	--bottom label
	rect(cartx-1,carty+35,cartx+32,carty+42,0)
	line(cartx+1,carty+37,cartx+#v.name,carty+37,7)
	line(cartx+1,carty+39,cartx+(#v.name*3)%20+2,carty+39,7)
	
	line(cartx+1,carty+41,cartx+10,carty+41,6)
	--markings
	line(cartx-1,carty-3,cartx+2,carty-3,7)
	pset(cartx+4,carty-4,7)
	line(cartx+20,carty-4,cartx+32,carty-4,6)

	
end

function fancydrawmain()
	rectfill(0,0,128,128,bgcolor)
	if #carts > 0 then
		for i,v in ipairs(carts) do
			drawcart(v)
		end
		--rect(44,44,83,83,7)
		print(carts[cpos+1].name,0,0,textcolor)
		rect(0,120,127,127,textcolor)
		
		local barx = dcpos/(numcarts-1)*128-3
		print('◆',barx,121,textcolor)
		print('◆',barx,122,textcolor)
	else
		print('no carts found!',34,50,textcolor)
	end
end


function fancy_draw()
	cls()
	clip()
	pal()
	palt(0,false)
	fancydrawmain()
	
	if showerror then
		rect(9,9,118,118,7)
		pal(darkenpal)
		clip(10,10,108,108)
		fancydrawmain()
		pal()
		for i,v in ipairs(errortable) do
			print(v,12,i*8+4,7)
		end
		
		
	end
end


-->8
--runner

inits = {classic_init,fancy_init}
function _init()
	theme = 1 
	
	inits[theme+1]()
end

updates = {classic_update,fancy_update}
function _update60()
	updates[theme+1]()
end

draws = {classic_draw,fancy_draw}
function _draw()	
	draws[theme+1]()
end



__gfx__
0123456789abcdef3333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
0001155d55ddd1dd3333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
33333333333377773333333333333333ddddddddddddddd77ddddddddddddddd88888888888888777788888888888888cccccccccc77777777cccccccccccccc
33333333333773337333333333333333ddddddddddddddd77ddddddddddddddd88888888888887788778888888888888cccccccccc7ccccccc7ccccccccccccc
33333333333733333773333333333333ddddddddddddddd77ddddddddddddddd88888888888877888887888888888888cccccccccccccccccc7ccccccccccccc
33333333337333333373333333333333dddddddddddddd7d7ddddddddddddddd88888888888778888888788888888888cccccccccccccccccc7ccccccccccccc
33333333337333333337333333333333ddddddddddddd7dd7ddddddddddddddd88888888888788888888788888888888cccccccccccccccccc7ccccccccccccc
33333333773333333333733333333333ddddddddddddd7dd7ddddddddddddddd88888888888888888888788888888888cccccccccccccccccc7ccccccccccccc
33333333773333333333373333333333dddddddddddd7ddd7ddddddddddddddd88888888888888888888788888888888cccccccccccccccccc7ccccccccccccc
33333337773333333333337333333333ddddddddddd77ddd7ddddddddddddddd88888888888888888888788888888888cccccccccccccccccc7ccccccccccccc
33333373733333333333337333333333dddddddddddddddd7ddddddddddddddd88888888888888888888788888888888cccccccccccccccc77cccccccccccccc
33333373333333333333337333333333dddddddddddddddd7ddddddddddddddd88888888888888888888788888888888ccccccccccccccc7777ccccccccccccc
33333373333333333333333733333333dddddddddddddddd7ddddddddddddddd88888888888888888888788888888888ccccccccccccccc77c7ccccccccccccc
33333337733333333333333733333333dddddddddddddddd7ddddddddddddddd88888888888888888888788888888888ccccccccccccccc7cc7ccccccccccccc
33333333373333333333337333333333ddddddddddddddd77ddddddddddddddd88888888888888888888788888888888cccccccccccccccccc7ccccccccccccc
33333333337733333333773333333333ddddddddddd77777777ddddddddddddd88888888888888888887888888888888cccccccccccccccccc7ccccccccccccc
33333333333773333777333333333333dddddddddddddddddd7777dddddddddd88888888888888888887888888888888ccccccccccccc77cc7cccccccccccccc
33333333333337777733333333333333dddddddddddddddddddddddddddddddd88888888888888888887888888888888ccccccccccccccc777cccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888878888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888877777788888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888877777888888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888777888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888777888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888778888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
33333333333333333333333333333333dddddddddddddddddddddddddddddddd88888888888888888888888888888888cccccccccccccccccccccccccccccccc
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777770777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777770777777077777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777770777777077777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777770777777077777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777770777770077777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777770777770000777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777770000000777077777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777770777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777770777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777770777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777770777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777770777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777770777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777077777077007077777000000007777007777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77000077077077077077000000000077077077077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777077777077770077770077777077077077777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77000077077077077077000000000077077077077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77000077077077007077777000000077770077770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

)#";